<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="/cssdocs/style.css">

    <title>Achatons</title>
</head>
<body>
    <div class="wrapper">
        <div class="container">
            <div class="flexRowCenter name">
                <h2>Achatons</h2>
            </div>
            <div class="text-message"></div>
            <div class="flexRowCenter text-input-container">
                <input id="submit-message-value" placeholder="Envoyer un doux message" type="text">
                <span id="submit-btn"><i class="fa-solid fa-paper-plane"></i></span>
            </div>
        </div>
    </div>
    
</body>

<script>
//set name:

function getLogin (message) {

    Swal.fire({
            title: message,
            input: 'text',
            inputAttributes: {
                autocapitalize: 'off'
            },
            showCancelButton: false,
            confirmButtonText: 'Look up',
            showLoaderOnConfirm: true,
            preConfirm: (login) => {
                return fetch(`/adduser/${login}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(response.statusText)
                    }
                    return response.json();
                })
                .catch(error => {
                    Swal.showValidationMessage(
                        `Votre compte n'a pas pu etre créer`
                    )
                })
            },
            allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
            if (result.isConfirmed) {

                if (!result.value.valid){
                    getLogin("Déja pris !");

                }else{
                    localStorage.setItem("name", result.value.login);
                    Swal.fire({
                        title: `Bienvenue ${result.value.login} :)`,
                    })
                }
  
            }else{
                getLogin();
            }
        })

}

    if (localStorage.getItem("name") == "" || localStorage.getItem("name") == null){
        getLogin("Veuillez saisir un pseudo");
    }

</script>

<script src="/socket.io/socket.io.js"></script>

<script>
    const LOGIN = localStorage.getItem('name');
    const textMessageContainer = document.querySelector("div.text-message");

    const sendMessage = document.querySelector("input#submit-message-value");
    const sendBtn = document.querySelector("span#submit-btn");

    // Establish a WebSocket connection
    const socket = io();
    let host = null;

    socket.on("connect", () => {
        host = socket.id;
        textMessageContainer.innerHTML = "";
        socket.emit('s-id', socket.id);
    });

    socket.on("start", (data) => {
        data = JSON.parse(data);
        loadMessage(data)
    });

    socket.on('receiveMessage', (message) => {
        value = JSON.parse(message);
        showMessage(value);
    });

    function getReceiveMessageHTML (senderName, messageValue) {
        return `<div class="left-message"> <div class="message-container"> <p class="message-sender">${senderName}:</p><p class="message-value">${messageValue}</p></div></div>`;
    }

    function getSendMessageHTML (senderName, messageValue) {
        return `<div class="right-message"> <div class="message-container"> <p class="message-sender">${senderName}:</p><p class="message-value">${messageValue}</p></div></div>`;
    }

    function showMessage (value) {
        if (value.name === LOGIN){
            textMessageContainer.innerHTML += getSendMessageHTML(value.name , value.message)
        }else{
            textMessageContainer.innerHTML += getReceiveMessageHTML(value.name, value.message)
        }
    }

    function loadMessage (data) {
        data.forEach(message => {
            showMessage(message);
        });
    }

    
    sendBtn.addEventListener('click', () => {
        if (sendMessage.value != ""){
            const message = JSON.stringify({author:host , name: localStorage.getItem('name') , message: sendMessage.value}); 
            socket.emit('sendMessage', message );
            sendMessage.value = "";
        }
    });


</script>
</html>